<!DOCTYPE html>
<html>
<head lang="zh-cn">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimal-ui">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/custom.css">
    <title>WebApp阅读器</title>
</head>
<body>
<div class="container">
    <!--头部-->
    <div class="public-top" style="display: none" id="public_top">
          <div class="icon-back"></div>
          <div class="public-top-title">返回书架</div>
    </div>
    <!--主体-->
    <div class="m-content" id="m_content">
            <!-- <h4>第004章 绝处逢生？</h4>
             <p>从朱莉家出来后，盛夏在招待所将就了一夜。闺蜜小雅想让盛夏住她家去，但盛夏没同意。</p>
             <p>小雅和她男朋友挤在一个二十多平的一室户里，就算能挪出地方来给她，两个女的，一个男的，也太不方便。</p>
             <p>盛夏无奈之下，就搬到了自己打临时工的超市。</p>
             <p>这家超市是西林本土的一家小型连锁店。店面铺得广，员工又多，提供住的地方，所以工资不高。</p>
             <p>盛夏以前也想过要住超市宿舍。可是……就一个一百平的仓库，还要隔开男女宿舍，洗澡间，卫生间，厨房，饭厅。四个女工，七个男工挤在一处。</p>
             <p>再有，她刚来住第一天的时候，是跟另外一个女工挤一块。当时她想着能等来程悦导演那边的通知，只说借住几天就好。</p>
             <p>谁知道，现在七天过去了，导演那边依旧没有消息。</p>
             <p>而几个女工见她一直不走，也心生了不满。</p>
             <p>这个时候，再提出来要在这边多铺一张床？</p>
             <p>盛夏有些开不了口。</p>
              <p>这个社会，就是这样。你自己觉得跟他们没什么两样，但一个大学毕业生的身份就跟这些初中生毕业的女工有了天壤之别。更何况她身材好，样貌好，气质好，超市的男工处处迁就她，就更让那些女工嫉妒。</p>
             <p>可，不住在这里……又真的是没有地方可以去。</p>
             <p>下了班，陆陆续续的几个女工都回了宿舍，人员都到齐了。</p>
             <p>面子值几个钱呢？还是拉下脸来说好了。</p>
             <p>盛夏打定了主意，她看着宿舍里的带头人阿玲走进来，便下意识的往前走了一步。</p>
             <p>“阿玲姐……”</p>
             <p>盛夏喊了一声。</p>
             <p>“唉，小夏，你在这里啊，正好我有个事情问你，昨天就你一个人轮休，你看到我们宿舍里有外人进来吗？”</p>
             <p>“啊？”忽然发问，打断盛夏的说话，盛夏有些不知所措。又想到她问的问题，盛夏低头想了想，道，“没有的，昨天就我一个人在这边睡了一天，没有外人进来。”</p>
             <p>“确定？”阿玲姐就在她话音刚落的时候，立马转过头来看着她。目光如炬。</p>
             <p>盛夏被她瞧的有些莫名其妙，隐约觉得有什么不好的事情发生，但她仍是点了点头。</p>
             <p>果然，她刚点头，阿玲就坐到了盛夏对面的椅子上，手里的毛巾啪地一下摔到了桌面上，同时，和阿玲相好的另外几个女工都齐刷刷的站到了她身后。整齐的跟块门板一样。</p>
             <p>这架势，盛夏不自觉得往后退了一步。</p>
             <p>“盛夏，本来，你忽然要来住，我们没意见。你要是手头困难，你跟我们几个姐们说，能帮的一定帮，但是，手脚不干净，拿我们的东西，这可不是清白人该做的。我那金镯子，是我那短命的死鬼留给我的唯一念想，你拿出来，我们既往不咎。”</p>
             <p>“不是，阿玲姐，你是不是误会了什么！我没有拿你的东西。”忽然来的变故，登时让盛夏手足无措。</p>
             <p>“你都说了没有外人，不是你，难不成是鬼不成？”</p>
             <p>“不是，阿玲姐，这里又不是只住了我一个。”</p>
             <p>“那你的意思是他们几个咯？”</p>
             <p>盛夏话音刚落，阿玲就抓住了她的话茬，回过头，圆滚滚的手指划过她身后的几个女工。</p>
             <p>而那几个女工，也已经被她的话挑染，一个个开始七嘴八舌。</p>
             <p>“不是，阿玲姐，我不是这个意思。”</p>
             <p>盛夏从前也不是很善言辞，因为家境，因为身份的悬殊，她跟同学都走得不近。现下这种情况，她根本有口莫辩。</p>
             <p>“不是，不是他们，就是你咯。”</p>
             <p>阿玲趁势起身，一双眼睛狠狠的盯着盛夏，一句话判了她的死刑。</p>
             <p>这样武断，也不容人解释。</p>
             <p>盛夏盯着他们，眼泪都快急出来了。</p>
             <p>而几个女工，没经过她的同意，已经动身去翻她的箱子。</p>
             <p>“你们不能这样，我没有拿，你们怎么可以随便翻我的东西，这是犯法的。”盛夏冲到自己箱子边上，一把扒拉开她们，死死护住自己的箱子。</p>
             <p>可是，她一个人，压根抵挡不住她们三个人。她们狠狠扯着她的胳膊将她拉开，然后打开了她的箱子。一个女工乱七八糟的将她的衣服抖开，里面赫然掉出来一个金镯子。</p>
             <p>盛夏的脸一下子黑了。</p>-->
    </div>
    <!--中间点击部分-->
    <div class="mid-action" id="mid_action"></div>

    <div class="page-button">
        <ul class="u-tab" id="u_tab" style="display: none;">
            <li id="prev">上一页</li>
            <li id="next">下一页</li>
        </ul>
    </div>

    <!--设置字体栏-->
    <div class="font-bar-shadow" style="display: none" id="font_bar_shadow"></div>
    <div class="font-bar" style="display: none" id="font_bar">
        <div class="font-mod">
            <span>字体</span>
            <button type="button" id="large-btn">放大</button>
            <button type="button" id="small-btn">缩小</button>
        </div>
        <div class="font-mod" id="bgMod">
            <span>背景</span>
            <div class="bk-container" style="background-color:#f7eee5">
                <div class="bk-container-current"></div>
            </div>
            <div class="bk-container" style="background-color:#e9dfc7">
                <div class="bk-container-current"></div>
            </div>
            <div class="bk-container" style="background-color:#a4a4a4">
                <div class="bk-container-current"></div>
            </div>
            <div class="bk-container" style="background-color:#cdefce">
                <div class="bk-container-current"></div>
            </div>
            <div class="bk-container" style="background-color:#283548">
                <div class="bk-container-current"></div>
            </div>
            <div class="bk-container" style="background-color:#0f1410">
                <div class="bk-container-current"></div>
            </div>
        </div>
    </div>
    <!--底部-->
    <div class="footer-shadow" style="display: none" id="footer_shadow"></div>
    <div class="footer clear" style="display: none" id="footer">
        <div class="footer-item">
            <div class="icon-menu"></div>
            <div class="icon-text">目录</div>
        </div>
        <div class="footer-item" id="font">
            <div class="icon-font"></div>
            <div class="icon-text">字体</div>
        </div>
        <div class="footer-item" id="day_night">
            <div class="icon-night"></div>
            <div class="icon-text">夜间</div>
        </div>
    </div>
</div>
<script src="lib/zepto.min.js"></script>
<script>
    window.jQuery = $;
</script>
<script src="js/jquery.base64.js"></script>
<script src="js/jquery.jsonp.js"></script>

<script>
    (function(){
        /*工具方法localStorage*/
        var Util=(function(){
            var prefix='html5_reader_';
            var StorageGetter=function(key){
                return localStorage.getItem(prefix+key);
            };
            var StorageSetter=function(key,val){
                return localStorage.setItem(prefix+key,val);
            };
            //获取json
            var getBSON=function(url,callback){
                return $.jsonp({
                    url:url,
                    cache:true,//缓存
                    callback:'duokan_fiction_chapter',
                    success:function(result){
                       // debugger;
                        var data=$.base64.decode(result);
                        var json=decodeURIComponent(escape(data));
                        callback(json);
                        //console.log(json);
                    }
                })
            };
            return{
                getBSON:getBSON,
                StorageGetter:StorageGetter,
                StorageSetter:StorageSetter
            }
        })();
        var Dom={
            mid_action:$('#mid_action'),
            footer:$('#footer'),
            footer_shadow:$('#footer_shadow'),
            font_bar:$('#font_bar'),
            font_bar_shadow:$('#font_bar_shadow'),
            public_top:$('#public_top'),
            m_content:$('#m_content'),
            win:$(window),
            font:$('#font'),
            body:$('body'),
            uTab:$('#u_tab'),
            uTabChild:$('#u_tab').children()
        };
        //画一下基本的展示框架
        function RenderBaseFrame(container) {

            function parseChapterData(jsonData) {
                //console.log(jsonData);
                var jsonObj = JSON.parse(jsonData);
                var html = "<h4>" + jsonObj.t + "</h4>";
                for (var i = 0; i < jsonObj.p.length; i++) {
                    html += "<p>" + jsonObj.p[i] + "</p>";
                }
                return html;

            }

            return function(data) {
                container.html(parseChapterData(data));

            };
        }

        //初始化的字体大小
        var InitFontSize;
        //字体设置信息
        InitFontSize = Util.StorageGetter('font_size');
        InitFontSize = parseInt(InitFontSize);
        if (!InitFontSize) {
            InitFontSize = 14;
        }
        Dom.m_content.css('font-size', InitFontSize);
        Util.StorageSetter('font_size',InitFontSize);

        /*设置默认背景颜色*/
        var bg ;//默认body 背景颜色
        var m_content_Color;//默认主题文字颜色
        var index;

        var nightText; //夜间和白天的记录
        var iconNight_Day;

        index=Util.StorageGetter('index');
        if(!index){
            index=0;
        }
        $('#bgMod').children('.bk-container').eq(index).children().show();
        Util.StorageSetter('index',index);



        nightText=Util.StorageGetter('nightText');
        if(!nightText){
            nightText='夜间';
        }
        $('#day_night').children('.icon-text').text(nightText);

        Util.StorageSetter('nightText',nightText);


        iconNight_Day=Util.StorageGetter('iconNight_Day');
        if(!iconNight_Day){
            iconNight_Day='icon-night'
        }
        $('#day_night').children('.icon-night').attr('class',iconNight_Day);
        Util.StorageSetter('iconNight_Day',iconNight_Day);



        bg=Util.StorageGetter('bg');
        if(!bg){
            bg='#e9dfc7';
        }
        Dom.body.css('background-color',bg);
        Util.StorageSetter('bg',bg);


        m_content_Color=Util.StorageGetter('m_content_Color');
        if(!m_content_Color){
            m_content_Color='';
        }
        Dom.m_content.css('color',m_content_Color);
        Util.StorageSetter('m_content_Color',m_content_Color);
        var readerModel;
        var readerUI;

        function main(){
            //todo 整个项目的入口函数
            readerModel=ReaderModel();//建立模型
            readerUI=ReaderBaseFrame(Dom.m_content);
            readerModel.init(function(data){  //初始化数据
                readerUI(data);
                $('#u_tab').show();
            });


             EventHandler();
        }

        function ReaderModel(){
            // todo 实现和阅读器相关的数据交互的方法
            var Chapter_id;
            var ChapterTotal;
            //初始化函数
            var init=function(Uicallback){
                getFictionInfo(function(){
                    getCurChapterContent(Chapter_id,function(data){
                        // todo ..返回得到的json数据 回调函数返回json 数据
                        Uicallback && Uicallback(data);
                    });
                });
            };
            // todo 获得章节的Chapter_id 和 ChapterTotal
            var getFictionInfo=function(callback){
                $.get('data/chapter.json',function(data){
                    Chapter_id=Util.StorageGetter("Chapter_id")||1;//设置Chapter_id 从本地存储拿,不存在则设为1
                    ChapterTotal=data.chapters.length;
                    callback && callback();

                },'json');
            };

            //获得章节的URl和json
            var getCurChapterContent=function(chapter_id,callback){
                $.get('data/data'+chapter_id+'.json',function(data){
                    if(data.result==0){
                        var url=data.jsonp;
                        Util.getBSON(url,function(data){
                            callback && callback(data);
                        });
                    }
                },'json');
            };
            //todo 上一页
            var prevChapter=function(Uicallback){
                Chapter_id=parseInt(Chapter_id,10);
                if(Chapter_id==0){
                    return;
                }
                Chapter_id-=1;
                getCurChapterContent(Chapter_id,Uicallback);
                Util.StorageSetter("Chapter_id",Chapter_id);//保存当前的Chapter_id 章节
            };
            // todo 下一页
            var nextChapter=function(Uicallback){
                Chapter_id=parseInt(Chapter_id,10);
                if(Chapter_id==ChapterTotal){
                    return;
                }
                Chapter_id += 1;
                getCurChapterContent(Chapter_id,Uicallback);
                Util.StorageSetter("Chapter_id",Chapter_id);//保存当前的Chapter_id 章节
            };


            return {
                init:init,
                prevChapter:prevChapter,
                nextChapter:nextChapter,
            }

        }


        function ReaderBaseFrame(container){
            // todo 渲染基本的UI结构
            function parseChapterData(jsonData){
                var jsonObj=JSON.parse(jsonData);/* json (JSON) 字符串转换为对象。*/
                var html="<h4>"+jsonObj.t+"</h4>";
                for(var i=0;i<jsonObj.p.length;i++){
                    html+="<p>"+jsonObj.p[i]+"</p>";
                }
                return html;
            }
            return function(data){
                container.html(parseChapterData(data))
            }

        }

        function EventHandler(){
            //字体和背景的颜色表
            var colorArr = [{
                bgValue : '#f7eee5',
                font : '#333'
                }, {
                bgValue : '#e9dfc7',
                font : '',
            }, {
                bgValue : '#a4a4a4',
                font : '#333'
            }, {
                bgValue : '#cdefce',
                font : '#000'
            }, {
                bgValue : '#283548',
                font : '#7685a2'
            }, {
                bgValue : '#0f1410',
                font : '#4e534f'
            }];
            $('#bgMod').children('.bk-container').click(function(){
               $(this).find('.bk-container-current').show().parent().siblings().find('.bk-container-current').hide();
                var index=$(this).index();
                Util.StorageSetter('index',index-1);
                var colorVal=colorArr[index-1];
                Dom.body.css('background-color',colorVal.bgValue);
                Util.StorageSetter('bg',colorVal.bgValue);
                Dom.m_content.css('color',colorVal.font);
                Util.StorageSetter('m_content_Color',colorVal.font);
            });


            //todo 交互的事件绑定
           Dom.mid_action.click(function(){
             if(Dom.public_top.css('display')=='none'){
                 Dom.public_top.show();
                 Dom.footer.show();
                 Dom.footer_shadow.show();
             }else{
                 Dom.public_top.hide();
                 Dom.footer.hide();
                 Dom.footer_shadow.hide();
                 Dom.font_bar.hide();
                 Dom.font_bar_shadow.hide();
             }
            });

            Dom.win.on('scroll',function(){
                Dom.public_top.hide();
                Dom.footer.hide();
                Dom.footer_shadow.hide();
                Dom.font_bar.hide();
                Dom.font_bar_shadow.hide();
            });
            //字体点击唤出面板
            Dom.font.click(function(){
              if(Dom.font_bar.css('display')=='none') {
                  Dom.font_bar.show();
                  Dom.font_bar_shadow.show();
                  Dom.font.children('.icon-font').attr('class','icon-font-active');
              }else{
                  Dom.font_bar.hide();
                  Dom.font_bar_shadow.hide();
                  Dom.font.children('.icon-font-active').attr('class','icon-font');
              }
            });



            //夜间模式
            $('#day_night').click(function(){
               if($(this).children('.icon-text').html()=='夜间'){
                   $(this).children('.icon-night').attr('class','icon-night-active');
                   Util.StorageSetter('iconNight_Day','icon-night-active');

                   $(this).children('.icon-text').html('白天');

                   Util.StorageSetter('nightText','白天');//记录白天

                   Dom.body.css('background-color','#0f1410');
                   Util.StorageSetter('bg','#0f1410');

                   Dom.m_content.css('color','#4e534f');
                   Util.StorageSetter('m_content_Color','#4e534f');

                   Dom.uTab.css('opacity','0.6');

                   Dom.uTabChild.css('color','rgba(255, 255, 255, 0.701961)');


                   $('#bgMod').children().last().children().show().parent().siblings().children().hide();

               }else{
                   $(this).children('.icon-night-active').attr('class','icon-night');

                   Util.StorageSetter('iconNight_Day','icon-night');

                   $(this).children('.icon-text').html('夜间');


                   Util.StorageSetter('nightText','夜间');//记录夜间

                   Dom.body.css('background-color','#e9dfc7');
                   Util.StorageSetter('bg','#e9dfc7');

                   Dom.m_content.css('color','');
                   Util.StorageSetter('m_content_Color','');

                   Dom.uTab.css('opacity','0.9');


                   Dom.uTabChild.css('color','');

                   $('#bgMod').children().last().children().hide();


               }

            });
            $('#large-btn').click(function(){
               if (InitFontSize > 19) {
                    return;
                }else{
                   InitFontSize += 1;
                   Util.StorageSetter('font_size', InitFontSize);
                   Dom.m_content.css('font-size', InitFontSize);
               }
            });

            $('#small-btn').click(function(){
                if (InitFontSize < 13) {
                    return;
                }else{
                    InitFontSize -= 1;
                    Util.StorageSetter('font_size', InitFontSize);
                    Dom.m_content.css('font-size', InitFontSize);
                }
            });
          $('#prev').click(function(){
                readerModel.prevChapter(function(data){
                    readerUI(data);
                    $('#u_tab').show();
                });
                window.scrollTo(0,0)
            });
           $('#next').click(function(){
              // alert(123);
                readerModel.nextChapter(function(data){
                    readerUI(data);
                    $('#u_tab').show();
                });
                window.scrollTo(0,0)
           });
        }
       main();
    })();
</script>
</body>
</html>